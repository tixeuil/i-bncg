Code for the undirected case
